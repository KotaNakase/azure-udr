## UDRとFWを使ってみた

UDRとFWをAzureで使用する機会があったので備忘録として使い方・用途をここに書き残します。

### まえがき
そもそもAzureで作成したリソース（VM等）からの通信（ネットワーク・Azureリソース・オンプレミス）は**システムルート**と呼ばれるものでルーティングが設定されているそう。仮想ネットワーク内のサブネットに自動で割り当てられるものらしい。

以下の表がデフォルトで設定されるテーブル（route table）。

*[公式ドキュメント](https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#default)から引用*


| source |  アドレス プレフィックス  |  ネクストホップの種類  |
| --- | ---- | ---  |
| Default | 仮想ネットワークに固有 | 仮想ネットワーク |
| Default | 0.0.0.0/0 | インターネット |
| Default | 10.0.0.0/8 | なし |
| 既定値 | 172.16.0.0/12 | なし |
| Default | 192.168.0.0/16 | なし |
| Default | 100.64.0.0/10 | なし |

アドレスプレフィックス宛の通信をどのようにルーティングするかを示したものであり、ネクストホップの内容がそれに該当します。

もう少しかみ砕いた説明をすると、route tableで設定した宛先以外は基本的に0.0.0.0/0（全てのアドレス）に該当し、インターネットに接続される、ということ。

また、ネクストホップの種類が「なし」のものはサブネットの外部に**ルーティングされずにトラフィックが破棄**されます。

なので、このシステムルートに存在しない独自のルーティングを行いたい場合は、**何かしらの方法**が必要ということになります。（FWを経由させた通信を行いたいとか）

その何かしらの方法というのが、**カスタムルート**を作成することであり、今回使用するUDRによってそれが実現できます。

### UDR
UDR(User Difine Route)...ユーザー定義ルート。デフォルトで割り当てられたルートに新たにルートを追加できます。

つまり、UDRを設定してあげればFWを経由した通信が実装で切るようになります。


### 作ってみた構成
今回検証用に作成した公正は以下の図の通り
![作ってみた構成](img/udr構成.png)

早速作ってみる。

[参考資料](https://learn.microsoft.com/ja-jp/azure/firewall/tutorial-firewall-deploy-portal-policy)


